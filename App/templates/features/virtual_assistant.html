{% extends "features/base.html" %} {% block title %}Virtual Assistant - RINDANG{% endblock %} {% block content %}
<div class="container my-3">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-green-dark text-white">
                    <h5 class="mb-0">RINDANG Virtual Assistant</h5>
                </div>
                <div class="card-body" style="height: 400px; overflow-y: auto; scroll-behavior: smooth" id="chatbox">
                    <!-- Chat messages will be appended here -->
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" id="user_input" class="form-control" placeholder="Type your message..." />
                        <button class="btn btn-green fw-bold text-white" onclick="sendMessage()">Kirim<i class="bi bi-send-fill ms-2"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .typing-indicator {
        display: inline-block;
        padding: 5px 10px;
        background-color: #e0e0e0;
        border-radius: 20px;
    }
    .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left;
        margin: 0 1px;
        background-color: #9e9ea1;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
    }
    .typing-indicator span:nth-of-type(1) {
        animation: 1s blink infinite 0.3333s;
    }
    .typing-indicator span:nth-of-type(2) {
        animation: 1s blink infinite 0.6666s;
    }
    .typing-indicator span:nth-of-type(3) {
        animation: 1s blink infinite 0.9999s;
    }
    @keyframes blink {
        50% {
            opacity: 1;
        }
    }
</style>
{% endblock %} {% block scripts %}
<script>
    const chatbox = document.getElementById('chatbox');
    let lastRequestTime = 0;
    const requestLimit = 5; // 5 requests per second
    const requestInterval = 1000; // 1 second in milliseconds

    function smoothScrollToBottom() {
        const lastMessage = chatbox.lastElementChild;
        if (lastMessage) {
            lastMessage.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }

    function appendMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-3 ${sender === 'Anda' ? 'text-end' : ''}`;
        messageDiv.innerHTML = `
            <div class="d-inline-block p-2 rounded ${sender === 'Anda' ? 'bg-light' : 'bg-green-secondary'}" style="max-width: 80%;">
                <strong>${sender}:</strong> ${message}
            </div>
        `;
        chatbox.appendChild(messageDiv);
        smoothScrollToBottom();
    }

    function appendTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'mb-3';
        typingDiv.innerHTML = `
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        chatbox.appendChild(typingDiv);
        smoothScrollToBottom();
        return typingDiv;
    }

    function removeTypingIndicator(element) {
        if (element && element.parentNode) {
            element.parentNode.removeChild(element);
        }
    }

    function sendMessage() {
        const userInput = document.getElementById('user_input');
        const userMessage = userInput.value.trim();
        if (!userMessage) {
            return;
        }

        const currentTime = Date.now();
        if (currentTime - lastRequestTime < requestInterval / requestLimit) {
            alert('Mohon tunggu sebentar sebelum mengirim pesan yang lain.');
            return;
        }

        appendMessage('Anda', userMessage);
        userInput.value = '';
        lastRequestTime = currentTime;

        const typingIndicator = appendTypingIndicator();

        fetch('/api/gemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: userMessage }),
        })
            .then((response) => {
                if (!response.ok) {
                    return response.json().then((err) => {
                        throw new Error(err.error || 'An unknown error occurred.');
                    });
                }
                return response.json();
            })
            .then((data) => {
                removeTypingIndicator(typingIndicator);
                const assistantReply = data.reply ? data.reply : 'No response from assistant.';
                appendMessage('Assistant', assistantReply);
            })
            .catch((error) => {
                removeTypingIndicator(typingIndicator);
                console.error('Error:', error);
                appendMessage('System', `An error occurred: ${error.message}`);
            });
    }

    // Allow sending message with Enter key
    document.getElementById('user_input').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });

    // Function to display welcome message
    function displayWelcomeMessage() {
        const welcomeMessage = `Selamat datang di Virtual Assistant RINDANG! ðŸ‘‹ðŸŒ±

Saya di sini untuk membantu Anda dengan berbagai pertanyaan seputar pertanian di Kota Ternate. Anda bisa bertanya tentang:

â€¢ Cara merawat tanaman
â€¢ Rekomendasi pupuk
â€¢ Tips menghadapi cuaca ekstrem
â€¢ Teknologi pertanian terbaru
â€¢ Dan banyak lagi!

Silakan ajukan pertanyaan Anda, dan saya akan dengan senang hati membantu!`;

        appendMessage('Assistant', welcomeMessage);
    }

    // Display welcome message when the page loads
    window.onload = displayWelcomeMessage;
</script>
{% endblock %}
