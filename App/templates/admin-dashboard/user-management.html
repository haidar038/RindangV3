{% extends 'admin-dashboard/layout.html' %} {% block title %} Dashboard - User Management {% endblock %} {% block container %}
<div class="container-fluid">
    <h2 class="fw-bolder">User Management</h2>
    <p class="text-muted mb-4">Manage members and their account permission here</p>
    <div class="row mb-3">
        <div class="col-md-6 col-sm-12 mb-lg-0 mb-sm-3">
            <input type="text" id="searchInput" class="form-control bg-light" placeholder="Search users..." />
        </div>
        <div class="col-md-6 col-sm-12">
            <select id="roleFilter" class="form-select bg-light">
                <option value="">All Roles</option>
                <option value="personal">Personal</option>
                <option value="petani">Petani</option>
                <option value="ahli">Ahli</option>
            </select>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-light table-hover">
            <thead>
                <tr>
                    <th scope="col">No</th>
                    <th scope="col">Nama</th>
                    <th scope="col">Username</th>
                    <th scope="col">Email</th>
                    <th scope="col">Status</th>
                    <th scope="col">Role</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- User data will be populated here -->
            </tbody>
        </table>
    </div>
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be populated here -->
        </ul>
    </nav>
</div>

<!-- Modal for user details -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userDetailsBody">
                <!-- User details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for user verification -->
<div class="modal fade" id="userVerificationModal" tabindex="-1" aria-labelledby="userVerificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userVerificationModalLabel">Verify User Upgrade Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userVerificationBody">
                <!-- User verification details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="approveUpgradeBtn">Approve</button>
                <button type="button" class="btn btn-danger" id="rejectUpgradeBtn">Reject</button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    const users = {{ users_data | tojson | safe }};

    function populateUserTable(users) {
        const tableBody = $('#userTableBody');
        tableBody.empty();
        users.forEach((user, index) => {
            let upgradeRequestBadge = '';
            if (user.petani_request) {
                upgradeRequestBadge = '<span class="badge bg-warning">Petani Request</span>';
            } else if (user.ahli_request) {
                upgradeRequestBadge = '<span class="badge bg-info">Ahli Request</span>';
            }

            tableBody.append(`
                <tr>
                    <td>${index + 1}</td>
                    <td>${user.nama_lengkap || 'N/A'}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge ${user.is_confirmed ? 'bg-success' : 'bg-warning'}">
                            ${user.is_confirmed ? 'Confirmed' : 'Unconfirmed'}
                        </span>
                        ${upgradeRequestBadge}
                    </td>
                    <td><span class="badge bg-secondary">${user.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showUserDetails(${user.id})">Details</button>
                        ${(user.petani_request || user.ahli_request) ?
                            `<button class="btn btn-sm btn-warning" onclick="showVerificationModal(${user.id})">Verify</button>` :
                            ''}
                    </td>
                </tr>
            `);
        });
    }

    function showVerificationModal(userId) {
        const user = users.find(u => u.id === userId);
        if (user) {
            const modalBody = $('#userVerificationBody');
            modalBody.html(`
                <p><strong>Name:</strong> ${user.nama_lengkap || 'N/A'}</p>
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Current Role:</strong> ${user.role}</p>
                <p><strong>Requested Role:</strong> ${user.petani_request ? 'Petani' : 'Ahli'}</p>
                <p><strong>Verification Document:</strong> <a href="#" onclick="viewDocument('${user.verification_document}')">View Document</a></p>
            `);
            $('#userVerificationModal').modal('show');

            // Set up event listeners for approve and reject buttons
            $('#approveUpgradeBtn').off('click').on('click', function() {
                approveUpgrade(userId);
            });
            $('#rejectUpgradeBtn').off('click').on('click', function() {
                rejectUpgrade(userId);
            });
        }
    }

    function viewDocument(documentPath) {
        if (documentPath) {
            // Buka gambar dalam modal atau tab baru
            var img = new Image();
            img.onload = function() {
                var w = window.open("", "_blank");
                w.document.write(img.outerHTML);
            }
            img.src = '/verification_docs/' + documentPath;
        } else {
            alert('Dokumen tidak tersedia');
        }
    }

    function approveUpgrade(userId) {
        $.ajax({
            url: `/admin-dashboard/approve-upgrade/${userId}`,
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    // Update the users array
                    const userIndex = users.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        users[userIndex].role = users[userIndex].petani_request ? 'petani' : 'ahli';
                        users[userIndex].petani_request = false;
                        users[userIndex].ahli_request = false;
                        users[userIndex].is_verified = true;
                    }
                    // Refresh the table
                    populateUserTable(users);
                    $('#userVerificationModal').modal('hide');
                    // Show success message
                    toastr.success('User upgrade approved successfully');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                toastr.error('An error occurred while processing your request. Please try again.');
            }
        });
    }

    function rejectUpgrade(userId) {
        $.ajax({
            url: `/admin-dashboard/reject-upgrade/${userId}`,
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    // Update the users array
                    const userIndex = users.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        users[userIndex].petani_request = false;
                        users[userIndex].ahli_request = false;
                    }
                    // Refresh the table
                    populateUserTable(users);
                    $('#userVerificationModal').modal('hide');
                    // Show success message
                    toastr.success('User upgrade rejected successfully');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                toastr.error('An error occurred while processing your request. Please try again.');
            }
        });
    }

    function showUserDetails(userId) {
        const user = users.find(u => u.id === userId);
        if (user) {
            const modalBody = $('#userDetailsBody');
            modalBody.html(`
                <p><strong>Name:</strong> ${user.nama_lengkap || 'N/A'}</p>
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Role:</strong> ${user.role}</p>
                <p><strong>Status:</strong> ${user.is_confirmed ? 'Confirmed' : 'Unconfirmed'}</p>
                <p><strong>Verified:</strong> ${user.is_verified ? 'Yes' : 'No'}</p>
                <!-- Add more user details as needed -->
            `);
            $('#userDetailsModal').modal('show');
        }
    }

    $(document).ready(function () {
        populateUserTable(users);

        $('#searchInput').on('keyup', function () {
            const searchTerm = $(this).val().toLowerCase();
            const filteredUsers = users.filter(user =>
                (user.nama_lengkap && user.nama_lengkap.toLowerCase().includes(searchTerm)) ||
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            populateUserTable(filteredUsers);
        });

        $('#roleFilter').on('change', function () {
            const selectedRole = $(this).val();
            const filteredUsers = selectedRole ? users.filter(user => user.role === selectedRole) : users;
            populateUserTable(filteredUsers);
        });

        $('#saveChangesBtn').on('click', function() {
            // Implement save changes functionality if needed
            console.log('Save changes clicked');
            $('#userDetailsModal').modal('hide');
        });
    });
</script>
{% endblock %}
